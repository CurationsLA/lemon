name: CurationsLA Content to Ghost Draft

on:
  schedule:
    - cron: '0 13 * * *'  # 6 AM PT daily
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-and-source:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Verify Node.js version
      run: |
        node --version
        npm --version
        which node
        
    - name: Install dependencies
      run: npm install
      
    - name: Deploy Cloudflare Worker
      if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' }}
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        echo "Node version: $(node --version)"
        echo "CLOUDFLARE_API_TOKEN is available"
        npx wrangler deploy --compatibility-date=2024-01-01
        
    - name: Set Cloudflare Worker secrets
      if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' && secrets.GHOST_ADMIN_API_KEY != '' }}
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        GHOST_ADMIN_API_KEY: ${{ secrets.GHOST_ADMIN_API_KEY }}
      run: |
        echo "$GHOST_ADMIN_API_KEY" | npx wrangler secret put GHOST_ADMIN_API_KEY
        
    - name: Missing Secrets Warning
      if: ${{ secrets.CLOUDFLARE_API_TOKEN == '' || secrets.GHOST_ADMIN_API_KEY == '' }}
      run: |
        echo "⚠️ Missing required secrets:"
        echo "CLOUDFLARE_API_TOKEN: $([[ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]] && echo "✅ Set" || echo "❌ Missing")"
        echo "GHOST_ADMIN_API_KEY: $([[ -n "${{ secrets.GHOST_ADMIN_API_KEY }}" ]] && echo "✅ Set" || echo "❌ Missing")"
        echo ""
        echo "Please set these secrets in GitHub repository settings:"
        echo "Settings → Secrets and variables → Actions → Repository secrets"
        exit 1
        
    - name: Trigger content sourcing
      run: |
        sleep 30  # Allow deployment to propagate
        curl -X POST "https://la.curations.cc/api/source-content" \
          -H "Content-Type: application/json" \
          -d '{"trigger": "github-action"}'
          
    - name: Create Ghost draft from sourced content
      run: |
        sleep 10  # Allow content processing
        curl -X POST "https://la.curations.cc/api/create-draft" \
          -H "Content-Type: application/json" \
          -d '{
            "title": "CurationsLA Good Vibes - '$(date +"%B %d, %Y")'",
            "publicationDate": "'$(date +"%Y-%m-%d")'"
          }'